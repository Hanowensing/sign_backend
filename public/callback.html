<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google ë¡œê·¸ì¸ ì²˜ë¦¬</title>
</head>
<body>
    <script>
        /**
         * âœ… URLì—ì„œ Authorization Code ê°€ì ¸ì˜¤ê¸°
         */
        function getAuthCode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('code'); 
        }

        /**
         * âœ… Renderì— ë°°í¬ëœ ë°±ì—”ë“œ URLì„ ì‚¬ìš©í•´ì•¼ í•¨!
         * - `http://localhost:3000` âŒ (ë¡œì»¬ í™˜ê²½)
         * - `https://signcollector-api.onrender.com/auth/google` âœ… (ë°°í¬ëœ ë°±ì—”ë“œ)
         */
        const BACKEND_URL = "https://signcollector-api.onrender.com/auth/google"; // ğŸ”¥ Render ë°°í¬ëœ ë°±ì—”ë“œ URL ì ìš©

        /**
         * âœ… Authorization Codeë¥¼ ë°±ì—”ë“œì— ì „ë‹¬í•˜ì—¬ Access Token ìš”ì²­
         */
        async function sendAuthCodeToBackend(authCode) {
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: authCode })
                });

                const data = await response.json();

                if (data.access_token) {
                    console.log('âœ… Google Access Token:', data.access_token);
                    fetchUserInfo(data.access_token);
                } else {
                    console.error('âŒ í† í° ìš”ì²­ ì‹¤íŒ¨:', data);
                    alert("Google ë¡œê·¸ì¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    window.location.href = 'index.html'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
                }

            } catch (error) {
                console.error('âŒ ë°±ì—”ë“œ ìš”ì²­ ì˜¤ë¥˜:', error);
                alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                window.location.href = 'index.html';
            }
        }

        /**
         * âœ… Access Tokenìœ¼ë¡œ Google ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
         */
        async function fetchUserInfo(accessToken) {
            console.log("ğŸ“¥ Google API ìš”ì²­: Access Token ì‚¬ìš©", accessToken);

            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                const userInfo = await response.json();
                console.log('âœ… Google ì‚¬ìš©ì ì •ë³´:', userInfo);

                // âœ… ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                localStorage.setItem('googleUser', JSON.stringify(userInfo));
                localStorage.setItem("access_token", accessToken);

                // âœ… ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'mainpage.html';

            } catch (error) {
                console.error("âŒ ì‚¬ìš©ì ì •ë³´ ìš”ì²­ ì‹¤íŒ¨:", error);
                alert("Google ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                window.location.href = 'index.html';
            }
        }

        /**
         * âœ… ë¡œê·¸ì¸ ì‹œì‘
         */
        const authCode = getAuthCode();
        if (authCode) {
            console.log("ğŸ“Œ Authorization Code:", authCode);
            sendAuthCodeToBackend(authCode);
        } else {
            console.error('âŒ Authorization Code ì—†ìŒ');
            alert("Google ì¸ì¦ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
